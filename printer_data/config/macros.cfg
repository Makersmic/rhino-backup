[gcode_macro PREHEAT]
description: Preheat extruder and bed for a toolhead
gcode:
    {% set tool = params.TOOL|default("BlockOne") %}
    {% set config = printer["gcode_macro " ~ tool|lower ~ "_config"].config %}
    {% set material = params.MATERIAL|default("PLA") %}
    {% set materials = {
        "PLA": {"extruder_temp": 200, "bed_temp": 60},
        "ABS": {"extruder_temp": 230, "bed_temp": 90}
    } %}
    {% if not config %}
        M117 Error: Toolhead config missing
        { action_raise_error("Configuration for {tool} not found") }
    {% endif %}
    M104 S{materials[material].extruder_temp}
    M140 S{materials[material].bed_temp}
    M117 Preheating {tool} for {material}
    LEDFLASH STATUS=heating

[gcode_macro Bed_Calibrate]
description: Performs bed leveling or Z calibration
gcode:
    {% set tool = params.TOOL|default("BlockOne") %}
    {% set config = printer["gcode_macro " ~ tool|lower ~ "_config"].config %}
    {% if not config %}
        M117 Error: Toolhead config missing
        { action_raise_error("Configuration for {tool} not found") }
    {% endif %}
    {% set z_offset = config.z_offset|float %}
    {% set probe_type = config.probe_type %}
    M117 Calibrating bed for {tool} ({probe_type})
    G28
    {% if probe_type == "inductive" %}
        BED_MESH_CALIBRATE
    {% else %}
        G28 Z
        SET_GCODE_OFFSET Z={z_offset}
    {% endif %}
    LEDFLASH STATUS=calibrating

[gcode_macro SET_MATERIAL]
description: Set material for current toolhead
gcode:
    {% set material = params.MATERIAL|default("PLA") %}
    {% set temp = params.TEMP|float|default(200) %}
    {% set bed_temp = params.BED_TEMP|float|default(60) %}
    M117 Confirm {material} settings: Extruder {temp}C, Bed {bed_temp}C
    RESPOND TYPE=command MSG="action:prompt_begin Confirm {material} settings"
    RESPOND TYPE=command MSG="action:prompt_button OK|SET_MATERIAL MATERIAL={material} TEMP={temp} BED_TEMP={bed_temp} OK=1"
    RESPOND TYPE=command MSG="action:prompt_button Cancel|CANCEL"
    RESPOND TYPE=command MSG="action:prompt_end"
    {% if params.OK is defined %}
        M104 S{temp}
        M140 S{bed_temp}
        M117 Material set to {material}
        SAVE_VARIABLE VARIABLE=material VALUE="'{material}'"
    {% endif %}
