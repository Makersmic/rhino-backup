[respond]

[pause_resume]

[display_status]

[gcode_macro CANCEL_PRINT]
description: Cleanly cancel the current print
rename_existing: CANCEL_PRINT_BASE
gcode:
    M117 Canceling print...
    RESPOND TYPE=command MSG="action:notify Print canceled"
    TURN_OFF_HEATERS
    M107 ; Turn off fan
    G91
    G1 Z10 F900 ; Lift Z
    G90
    G28 X Y ; Home X and Y
    SAVE_VARIABLE VARIABLE=pause_state VALUE="'none'"
    CANCEL_PRINT_BASE
    M117 Print canceled
    LEDFLASH


[gcode_macro Bed_Calibrate]
description: Calibrate bed with visual feedback for deposition jobs
gcode:
  {% set TOOLHEAD = printer.save_variables.variables.set_material_toolhead|default("BlockOne") %}
  {% set MATERIAL = printer.save_variables.variables.set_material_material|default("PLA") %}
  {% set NOZZLE_SIZE = printer.save_variables.variables.set_material_nozzle_size|float|default(0.4) %}
  {% set EXTRUDER = printer.save_variables.variables.set_material_extruder_index|default(0)|int %}
  {% set toolheads = printer["gcode_macro VARIABLES"].toolheads %}
  {% if not toolheads %}
    RESPOND TYPE=error MSG="Toolheads configuration not found"
    { action_raise_error("Missing toolheads configuration") }
  {% endif %}
  {% set tool_type = toolheads[TOOLHEAD].type|default("DEPOSITION") %}
  {% if tool_type != "DEPOSITION" %}
    RESPOND TYPE=command MSG="action:notify Skipping bed calibration for {tool_type} toolhead"
    M117 Skipping bed calibration for {tool_type}
    { action_return() }
  {% endif %}
  _GENERATE_NOZZLE_KEY TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}
  {% set nozzle_key = printer.save_variables.variables.nozzle_key %}
  {% set led_pin = printer.save_variables.variables.get("led_pin", "Umbilical_LED") %}
  {% if led_pin not in printer %}
    RESPOND TYPE=error MSG="LED pin {led_pin} not found"
    { action_raise_error("Invalid LED pin") }
  {% endif %}

  M117 Calibrating bed for {nozzle_key}...
  RESPOND TYPE=command MSG="action:notify Calibrating bed for {nozzle_key}"
  LEDFLASH LED_PIN={led_pin}
  SET_PIN PIN={led_pin} VALUE=1.00

  {% if "xyz" in printer.toolhead.homed_axes %}
    {% if printer["z_tilt"] is defined %}
      Z_TILT_ADJUST
    {% else %}
      RESPOND TYPE=command MSG="action:notify Z_TILT_ADJUST not supported. Falling back to G28 Z."
      G28 Z
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG="Printer not homed for bed calibration"
    { action_raise_error("Printer not homed") }
  {% endif %}

  M117 Bed calibration complete
  RESPOND TYPE=command MSG="action:notify Bed calibration complete for {nozzle_key}"
  LEDFLASH LED_PIN={led_pin}
  SET_PIN PIN={led_pin} VALUE=0.00