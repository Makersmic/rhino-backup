
#######################################################################
#  RESET STATE
#######################################################################
[gcode_macro RESET_PRINTER_STATE]
description: Reset printer state to standby
gcode:
  M117 Resetting printer state...
  RESPOND TYPE=command MSG="action:notify Resetting printer state"
  CLEAR_PAUSE
  CANCEL_PRINT_BASE
  M117 Printer in standby
  RESPOND TYPE=command MSG="action:notify Printer in standby"


#######################################################################
#  JOB START (ENTRY POINT)
#######################################################################
[gcode_macro START_JOB]
description: Prepare and start a job with toolhead + material
gcode:
  #RESET_PRINTER_STATE
  home
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("PLA") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}

  M117 Preparing {TOOLHEAD} with {MATERIAL}...
  RESPOND TYPE=command MSG="action:notify Preparing {TOOLHEAD} with {MATERIAL}"

  CONFIRM_TOOLHEAD TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}


#######################################################################
#  CONFIRM TOOLHEAD (popup with auto-continue)
#######################################################################
[gcode_macro CONFIRM_TOOLHEAD]
description: Show popup confirmation
gcode:
  {% set TOOLHEAD = params.TOOLHEAD %}
  {% set MATERIAL = params.MATERIAL %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE %}
  {% set EXTRUDER = params.EXTRUDER %}
  {% set tool_type = printer["gcode_macro VARIABLES"].toolheads[TOOLHEAD].type %}

  RESPOND TYPE=command MSG="action:prompt_begin Confirm Toolhead and Material"
  RESPOND TYPE=command MSG="action:prompt_text Toolhead: {TOOLHEAD}"
  RESPOND TYPE=command MSG="action:prompt_text Material: {MATERIAL}"
  {% if tool_type == "DEPOSITION" %}
    RESPOND TYPE=command MSG="action:prompt_text Extruder: {EXTRUDER}"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle Size: {NOZZLE_SIZE} mm"
  {% endif %}
  RESPOND TYPE=command MSG="action:prompt_button Proceed|_CONFIRM_TOOLHEAD_RESPONSE RESPONSE=proceed TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}|success"
  RESPOND TYPE=command MSG="action:prompt_button Cancel|_CONFIRM_TOOLHEAD_RESPONSE RESPONSE=cancel|danger"
  RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _CONFIRM_TOOLHEAD_RESPONSE]
description: Handle confirmation popup
gcode:
  {% set RESPONSE = params.RESPONSE %}
  {% set TOOLHEAD = params.TOOLHEAD %}
  {% set MATERIAL = params.MATERIAL %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE %}
  {% set EXTRUDER = params.EXTRUDER %}
  RESPOND TYPE=command MSG="action:prompt_end"

  {% if RESPONSE == "proceed" %}
    M117 Proceeding with {TOOLHEAD}/{MATERIAL}
    RESPOND TYPE=command MSG="action:notify Proceeding with {TOOLHEAD}/{MATERIAL}"
    SET_TOOLHEAD TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER} SKIP_PROMPT=true
    START_SEQUENCE
  {% else %}
    M117 Job canceled by user
    RESPOND TYPE=command MSG="action:notify Job canceled by user"
    #RESET_PRINTER_STATE
  {% endif %}


#######################################################################
#  SEQUENCE WRAPPER (runs PreCheck, then print)
#######################################################################
[gcode_macro START_SEQUENCE]
description: Run safety/prep before file execution
gcode:
  M117 Running PreCheck...
  RESPOND TYPE=command MSG="action:notify Running PreCheck"
  PreCheck
  M117 Job starting...
  RESPOND TYPE=command MSG="action:notify Job starting"
  SDCARD_PRINT_FILE  ; start actual job


#######################################################################
#  TOOLHEAD DISPATCHER
#######################################################################
[gcode_macro SET_TOOLHEAD]
description: Setup toolhead and delegate
gcode:
  {% set TOOLHEAD = params.TOOLHEAD %}
  {% set MATERIAL = params.MATERIAL %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE %}
  {% set EXTRUDER = params.EXTRUDER %}
  {% set tool_type = printer["gcode_macro VARIABLES"].toolheads[TOOLHEAD].type %}

  {% if tool_type == "DEPOSITION" %}
    SET_PRINT TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}
  {% elif tool_type == "LASER" %}
    SET_LASER TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL}
  {% elif tool_type == "SPINDLE" %}
    SET_SPINDLE TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL}
  {% elif tool_type == "DRAG_KNIFE" %}
    SET_DRAG_KNIFE TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL}
  {% else %}
    RESPOND TYPE=error MSG="Unsupported tool type: {tool_type}"
    { action_raise_error("Unsupported tool type: " ~ tool_type) }
  {% endif %}


#######################################################################
#  DEPOSITION TOOL
#######################################################################
[gcode_macro SET_PRINT]
description: Configure deposition (extruder-based) toolhead
gcode:
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("PLA") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}

  # Validate toolhead exists
  {% if TOOLHEAD not in printer["gcode_macro VARIABLES"].toolheads %}
    RESPOND TYPE=error MSG="Toolhead {TOOLHEAD} not defined in VARIABLES"
    { action_raise_error("Toolhead " ~ TOOLHEAD ~ " not defined in VARIABLES") }
  {% endif %}

  {% set toolhead_data = printer["gcode_macro VARIABLES"].toolheads[TOOLHEAD] %}
  {% set extruder_count = toolhead_data.extruder_count|default(1)|int %}

  # Construct material key based on extruder count
  {% set material_key = MATERIAL ~ "_" ~ (NOZZLE_SIZE|string|replace(".", "_")) %}
  {% if extruder_count > 1 %}
    {% set material_key = material_key ~ "_T" ~ EXTRUDER %}
  {% endif %}

  # Validate material exists
  {% if 'materials' in toolhead_data and material_key in toolhead_data.materials %}
    {% set mat_settings = toolhead_data.materials[material_key] %}
    SAVE_VARIABLE VARIABLE=set_material_toolhead VALUE="'{TOOLHEAD}'"
    SAVE_VARIABLE VARIABLE=set_material_material VALUE="'{MATERIAL}'"
    SAVE_VARIABLE VARIABLE=set_material_nozzle_size VALUE={NOZZLE_SIZE}
    SAVE_VARIABLE VARIABLE=set_material_extruder_index VALUE={EXTRUDER}
    SAVE_VARIABLE VARIABLE=set_material_bed_temp VALUE={mat_settings.bed_temp|default(60)}
    SAVE_VARIABLE VARIABLE=set_material_extruder_temp VALUE={mat_settings.extruder_temp|default(200)}
    M117 {TOOLHEAD}/{MATERIAL} ready
  {% else %}
    RESPOND TYPE=error MSG="Material {material_key} not defined for toolhead {TOOLHEAD}"
    { action_raise_error("Material " ~ material_key ~ " not defined for toolhead " ~ TOOLHEAD) }
  {% endif %}


#######################################################################
#  LASER TOOL
#######################################################################
[gcode_macro SET_LASER]
description: Configure laser toolhead
gcode:
  {% set TOOLHEAD = params.TOOLHEAD %}
  {% set MATERIAL = params.MATERIAL %}
  SAVE_VARIABLE VARIABLE=set_material_toolhead VALUE="{TOOLHEAD}"
  SAVE_VARIABLE VARIABLE=set_material_material VALUE="{MATERIAL}"
  M117 {TOOLHEAD}/{MATERIAL} ready (laser)


#######################################################################
#  SPINDLE TOOL
#######################################################################
[gcode_macro SET_SPINDLE]
description: Configure spindle toolhead
gcode:
  {% set TOOLHEAD = params.TOOLHEAD %}
  {% set MATERIAL = params.MATERIAL %}
  SAVE_VARIABLE VARIABLE=set_material_toolhead VALUE="{TOOLHEAD}"
  SAVE_VARIABLE VARIABLE=set_material_material VALUE="{MATERIAL}"
  M117 {TOOLHEAD}/{MATERIAL} ready (spindle)


#######################################################################
#  DRAG KNIFE TOOL
#######################################################################
[gcode_macro SET_DRAG_KNIFE]
description: Configure drag-knife toolhead
gcode:
  {% set TOOLHEAD = params.TOOLHEAD %}
  {% set MATERIAL = params.MATERIAL %}
  SAVE_VARIABLE VARIABLE=set_material_toolhead VALUE="{TOOLHEAD}"
  SAVE_VARIABLE VARIABLE=set_material_material VALUE="{MATERIAL}"
  M117 {TOOLHEAD}/{MATERIAL} ready (drag knife)


#######################################################################
#  PRECHECK
#######################################################################
[gcode_macro PreCheck]
description: Safety checks before job
gcode:
  {% set TOOLHEAD = printer.save_variables.variables.set_material_toolhead %}
  {% set MATERIAL = printer.save_variables.variables.set_material_material %}
  {% set NOZZLE_SIZE = printer.save_variables.variables.set_material_nozzle_size|default(0.4)|float %}
  {% set EXTRUDER = printer.save_variables.variables.set_material_extruder_index|default(0)|int %}
  {% set tool_type = printer["gcode_macro VARIABLES"].toolheads[TOOLHEAD].type %}

  {% if tool_type == "DEPOSITION" %}
    PREHEAT
  {% elif tool_type == "LASER" %}
    M5
  {% elif tool_type == "SPINDLE" %}
    M5
  {% elif tool_type == "DRAG_KNIFE" %}
    SET_GCODE_OFFSET Z=0
  {% endif %}


#######################################################################
#  PREHEAT
#######################################################################
[gcode_macro PREHEAT]
description: Heat bed and nozzle before print with heatsoak for high bed temperatures
gcode:
  # Check if macro is already running to prevent re-entrant calls
  {% if printer["gcode_macro PREHEAT"].is_running|default(false) %}
    RESPOND TYPE=error MSG="PREHEAT: Already running, aborting"
    { action_raise_error("PREHEAT: Macro already running") }
  {% endif %}
  # Set running flag
  {% set _ = printer["gcode_macro PREHEAT"].update({'is_running': true}) %}

  {% set bed_temp = printer.save_variables.variables.set_material_bed_temp|default(60)|float %}
  {% set extruder_temp = printer.save_variables.variables.set_material_extruder_temp|default(200)|float %}
  {% set MATERIAL = printer.save_variables.variables.set_material_material|default("PLA") %}
  {% set TOOLHEAD = printer.save_variables.variables.set_material_toolhead|default("BlockOne") %}
  {% set current_bed_temp = printer.heater_bed.temperature|default(20)|float %}
  {% set temp_threshold = bed_temp * 0.95 %}
  {% set call_id = printer.gcode.script_counter|default(0)|int + 1 %}  ; Unique call identifier

  # Debug: Log entry
  RESPOND TYPE=command MSG="PREHEAT[call={call_id}]: Starting, TOOLHEAD={TOOLHEAD}, MATERIAL={MATERIAL}"

  M117 Preheating...
  RESPOND TYPE=command MSG="action:notify Preheating {TOOLHEAD} for {MATERIAL}"

  # Heat extruder normally
  M109 S{extruder_temp}

  # Debug: Log temperatures and threshold
  RESPOND TYPE=command MSG="PREHEAT[call={call_id}]: Current bed temp={current_bed_temp}, Target={bed_temp}, Threshold={temp_threshold}"

  # Check if heatsoak is needed (bed_temp > 85 and current temp < 95% of target)
  {% if bed_temp > 85 and current_bed_temp < temp_threshold %}
    M117 Heatsoak required for glass bed (Target: {bed_temp}C, Current: {current_bed_temp}C)
    RESPOND TYPE=command MSG="action:notify Heatsoak required for glass bed (Target: {bed_temp}C, Current: {current_bed_temp}C)"

    # Calculate temperature increments for 3-minute (180s) heatsoak with 6 steps (every 30s)
    {% set temp_diff = bed_temp - current_bed_temp %}
    {% set temp_step = temp_diff / 6 %}

    # Debug: Log heatsoak parameters
    RESPOND TYPE=command MSG="PREHEAT[call={call_id}]: Heatsoak params: temp_diff={temp_diff}, temp_step={temp_step}"

    # Perform heatsoak with fixed steps
    {% set step1_temp = (current_bed_temp + temp_step)|min(bed_temp)|float %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={step1_temp}
    M117 Heatsoak step 1/6: {step1_temp}C
    RESPOND TYPE=command MSG="action:notify Heatsoak step 1/6: {step1_temp}C"
    G4 P30000  ; Wait 30 seconds

    {% set step2_temp = (current_bed_temp + temp_step * 2)|min(bed_temp)|float %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={step2_temp}
    M117 Heatsoak step 2/6: {step2_temp}C
    RESPOND TYPE=command MSG="action:notify Heatsoak step 2/6: {step2_temp}C"
    G4 P30000

    {% set step3_temp = (current_bed_temp + temp_step * 3)|min(bed_temp)|float %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={step3_temp}
    M117 Heatsoak step 3/6: {step3_temp}C
    RESPOND TYPE=command MSG="action:notify Heatsoak step 3/6: {step3_temp}C"
    G4 P30000

    {% set step4_temp = (current_bed_temp + temp_step * 4)|min(bed_temp)|float %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={step4_temp}
    M117 Heatsoak step 4/6: {step4_temp}C
    RESPOND TYPE=command MSG="action:notify Heatsoak step 4/6: {step4_temp}C"
    G4 P30000

    {% set step5_temp = (current_bed_temp + temp_step * 5)|min(bed_temp)|float %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={step5_temp}
    M117 Heatsoak step 5/6: {step5_temp}C
    RESPOND TYPE=command MSG="action:notify Heatsoak step 5/6: {step5_temp}C"
    G4 P30000

    {% set step6_temp = bed_temp|float %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={step6_temp}
    M117 Heatsoak step 6/6: {step6_temp}C
    RESPOND TYPE=command MSG="action:notify Heatsoak step 6/6: {step6_temp}C"
    G4 P30000

    # Ensure final temperature is reached
    M190 S{bed_temp}
    M117 Heatsoak complete, calibrating bed...
    RESPOND TYPE=command MSG="action:notify Heatsoak complete, calibrating bed"
    BED_CALIBRATE
  {% else %}
    # Normal bed heating
    M190 S{bed_temp}
  {% endif %}

  M117 {TOOLHEAD} Preheat complete
  RESPOND TYPE=command MSG="action:notify {TOOLHEAD} Preheat complete"
  # Debug: Log exit
  RESPOND TYPE=command MSG="PREHEAT[call={call_id}]: Completed"
  # Clear running flag
  {% set _ = printer["gcode_macro PREHEAT"].update({'is_running': false}) %}


#######################################################################
#  JOB END
#######################################################################
[gcode_macro END_PRINT]
description: End print safely
gcode:
  M104 S0
  M140 S0
  M107
  G91
  G1 Z10 F600
  G90
  G1 X0 Y200 F6000
  M84
  M117 Print finished
  RESPOND TYPE=command MSG="action:notify Print finished"
  RESET_PRINTER_STATE

