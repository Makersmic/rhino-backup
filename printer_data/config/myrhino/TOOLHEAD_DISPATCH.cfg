#######################################################################
#  RESET STATE
#######################################################################
[gcode_macro RESET_PRINTER_STATE]
description: Reset printer state to standby
gcode:
  M117 Resetting printer state...
  RESPOND TYPE=command MSG="action:notify Resetting printer state"
  CLEAR_PAUSE
  CANCEL_PRINT_BASE
  M117 Printer in standby
  RESPOND TYPE=command MSG="action:notify Printer in standby"

#######################################################################
#  JOB PREP â€“ Called by user before starting a file
#######################################################################
[gcode_macro START_JOB]
description: Prepare printer for upcoming job
gcode:
  RESET_PRINTER_STATE
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("PLA") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}

  M117 Preparing {TOOLHEAD} with {MATERIAL}...
  RESPOND TYPE=command MSG="action:notify Preparing {TOOLHEAD} with {MATERIAL}"

  CONFIRM_TOOLHEAD TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}

#######################################################################
#  TOOLHEAD SETUP
#######################################################################
[gcode_macro SET_TOOLHEAD]
description: Setup toolhead and dispatch to type-specific macro
gcode:
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("PLA") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
  {% set SKIP_PROMPT = params.SKIP_PROMPT|default("false")|lower == "true" %}
  {% set toolheads = printer["gcode_macro VARIABLES"].toolheads %}
  {% set tool_type = toolheads[TOOLHEAD].type|default("DEPOSITION") %}

  {% if TOOLHEAD not in toolheads %}
    RESPOND TYPE=error MSG="Invalid TOOLHEAD: {TOOLHEAD}"
    { action_raise_error("Invalid TOOLHEAD: " ~ TOOLHEAD) }
  {% endif %}

  M117 Initializing toolhead {TOOLHEAD}...
  RESPOND TYPE=command MSG="action:notify Initializing toolhead {TOOLHEAD}"

  {% if tool_type == "DEPOSITION" %}
    SET_PRINT TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER} SKIP_PROMPT={SKIP_PROMPT}
  {% elif tool_type == "LASER" %}
    SET_LASER TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} SKIP_PROMPT={SKIP_PROMPT}
  {% elif tool_type == "SPINDLE" %}
    SET_SPINDLE TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} SKIP_PROMPT={SKIP_PROMPT}
  {% elif tool_type == "DRAG_KNIFE" %}
    SET_DRAG_KNIFE TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} SKIP_PROMPT={SKIP_PROMPT}
  {% else %}
    RESPOND TYPE=error MSG="Unsupported tool type: {tool_type}"
    { action_raise_error("Unsupported tool type: " ~ tool_type) }
  {% endif %}
  
#######################################################################
#  CONFIRM TOOLHEAD
#######################################################################
[gcode_macro CONFIRM_TOOLHEAD]
description: Show popup confirmation before starting
gcode:
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("PLA")|upper %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
  {% set tool_type = printer["gcode_macro VARIABLES"].toolheads[TOOLHEAD].type %}

  RESPOND TYPE=command MSG="action:prompt_begin Confirm Toolhead and Material"
  RESPOND TYPE=command MSG="action:prompt_text Toolhead: {TOOLHEAD}"
  RESPOND TYPE=command MSG="action:prompt_text Material: {MATERIAL}"
  {% if tool_type == "DEPOSITION" %}
    RESPOND TYPE=command MSG="action:prompt_text Extruder: {EXTRUDER}"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle Size: {NOZZLE_SIZE} mm"
  {% endif %}
  RESPOND TYPE=command MSG="action:prompt_button Proceed|_CONFIRM_TOOLHEAD_RESPONSE RESPONSE=proceed TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}|success"
  RESPOND TYPE=command MSG="action:prompt_button Cancel|_CONFIRM_TOOLHEAD_RESPONSE RESPONSE=cancel|danger"
  RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro SET_MATERIAL]
description: Sets job parameters for the specified toolhead, material, nozzle size, and extruder
gcode:
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("PLA") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
  {% set SKIP_PROMPT = params.SKIP_PROMPT|default("false")|lower == "true" %}
  {% set toolheads = printer["gcode_macro VARIABLES"].toolheads %}
  {% set tool_type = toolheads[TOOLHEAD].type|default("DEPOSITION") %}
  {% set nozzle_key = MATERIAL ~ (("_" ~ (NOZZLE_SIZE|string|replace(".", "_")) ~ "_T" ~ EXTRUDER) if TOOLHEAD == "SwitchFly" else (("_" ~ (NOZZLE_SIZE|string|replace(".", "_"))) if TOOLHEAD == "BlockOne" else "")) %}
  {% set settings = toolheads[TOOLHEAD].materials[nozzle_key] %}

  M117 Setting parameters for {nozzle_key}...
  RESPOND TYPE=command MSG="action:notify Setting parameters for {nozzle_key}"
  RESPOND MSG="Debug: Tool type: {tool_type}, Nozzle key: {nozzle_key}"

  # Validate settings
  {% if nozzle_key in toolheads[TOOLHEAD].materials %}
    # Universal parameters
    SAVE_VARIABLE VARIABLE=set_material_toolhead VALUE="'{TOOLHEAD}'"
    SAVE_VARIABLE VARIABLE=set_material_material VALUE="'{MATERIAL}'"
    SAVE_VARIABLE VARIABLE=set_material_nozzle_size VALUE={NOZZLE_SIZE}
    SAVE_VARIABLE VARIABLE=set_material_extruder_index VALUE={EXTRUDER}
    SAVE_VARIABLE VARIABLE=set_material_tool_type VALUE="'{tool_type}'"
    SAVE_VARIABLE VARIABLE=set_material_nozzle_key VALUE="'{nozzle_key}'"
    SET_GCODE_OFFSET Z={settings.z_offset|default(0.0)}
    SET_VELOCITY_LIMIT ACCEL={settings.accel|default(5000)} ACCEL_TO_DECEL={settings.accel|default(5000) / 2}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={settings.square_corner_velocity|default(5.0)}

    # Tool-specific parameters
    {% if tool_type == "DEPOSITION" %}
      SAVE_VARIABLE VARIABLE=set_material_bed_temp VALUE={settings.bed_temp|default(60)}
      SAVE_VARIABLE VARIABLE=set_material_extruder_temp VALUE={settings.extruder_temp|default(200)}
      SAVE_VARIABLE VARIABLE=set_material_fan_speed VALUE={settings.fan_speed|default(0.0)}
      SAVE_VARIABLE VARIABLE=set_material_load_length VALUE={settings.load_length|default(10)}
      SAVE_VARIABLE VARIABLE=set_material_load_speed VALUE={settings.load_speed|default(200)}
      SAVE_VARIABLE VARIABLE=set_material_load_wait VALUE={settings.load_wait|default(0)}
      SAVE_VARIABLE VARIABLE=set_material_purge_length VALUE={settings.purge_length|default(45)}
      SAVE_VARIABLE VARIABLE=set_material_purge_wait VALUE={settings.purge_wait|default(0)}
      {% if TOOLHEAD == "SwitchFly" %}
        {% if EXTRUDER == 0 %}
          SWITCH_T0 MATERIAL={nozzle_key}
        {% elif EXTRUDER == 1 %}
          SWITCH_T1 MATERIAL={nozzle_key}
        {% else %}
          RESPOND TYPE=error MSG="Invalid EXTRUDER: {EXTRUDER} for SwitchFly"
          { action_raise_error("Invalid EXTRUDER: " ~ EXTRUDER) }
        {% endif %}
      {% endif %}
    {% elif tool_type == "LASER" %}
      SAVE_VARIABLE VARIABLE=set_material_laser_power VALUE={settings.laser_power|default(0.0)}
      SAVE_VARIABLE VARIABLE=set_material_feed_rate VALUE={settings.feed_rate|default(1000)}
    {% elif tool_type == "SPINDLE" %}
      SAVE_VARIABLE VARIABLE=set_material_spindle_rpm VALUE={settings.spindle_rpm|default(10000)}
      SAVE_VARIABLE VARIABLE=set_material_feed_rate VALUE={settings.feed_rate|default(1000)}
    {% elif tool_type == "DRAG_KNIFE" %}
      SAVE_VARIABLE VARIABLE=set_material_feed_rate VALUE={settings.feed_rate|default(1000)}
    {% else %}
      RESPOND TYPE=error MSG="Unsupported tool type: {tool_type}"
      { action_raise_error("Unsupported tool type: " ~ tool_type) }
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG="Material {nozzle_key} not found for {TOOLHEAD}"
    { action_raise_error("Material " ~ nozzle_key ~ " not found for " ~ TOOLHEAD) }
  {% endif %}

  # Proceed to pre-job checks
  {% if not SKIP_PROMPT %}
    PreCheck
  {% endif %}


[gcode_macro _CONFIRM_TOOLHEAD_RESPONSE]
description: Handle confirmation popup response
gcode:
  {% set RESPONSE = params.RESPONSE|default("cancel") %}
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("PLA") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}

  {% if RESPONSE == "proceed" %}
    M117 Proceeding with {TOOLHEAD}/{MATERIAL}
    RESPOND TYPE=command MSG="action:notify Proceeding with {TOOLHEAD}/{MATERIAL}"
    SET_TOOLHEAD TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER} SKIP_PROMPT=true
  {% else %}
    M117 Job canceled by user
    RESPOND TYPE=command MSG="action:notify Job canceled by user"
    RESPOND TYPE=command MSG="action:prompt_end"
    RESET_PRINTER_STATE
  {% endif %}

[gcode_macro SET_PRINT]
description: Configures deposition job settings and calls SET_MATERIAL
gcode:
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("PLA") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
  {% set SKIP_PROMPT = params.SKIP_PROMPT|default("false")|lower == "true" %}
  
  _GENERATE_NOZZLE_KEY TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}
  {% set nozzle_key = printer.save_variables.variables.nozzle_key %}
  
  M117 Setting up deposition job for {nozzle_key}...
  RESPOND TYPE=command MSG="action:notify Setting up deposition job for {nozzle_key}"
  RESPOND MSG="Debug: SET_PRINT called with TOOLHEAD={TOOLHEAD}, MATERIAL={MATERIAL}, NOZZLE_SIZE={NOZZLE_SIZE}, EXTRUDER={EXTRUDER}, SKIP_PROMPT={SKIP_PROMPT}, Print state: {printer.print_stats.state}"

  # Apply deposition-specific settings
  SET_MATERIAL TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER} SKIP_PROMPT={SKIP_PROMPT}
  
[gcode_macro SET_LASER]
description: Configures laser job settings and calls SET_MATERIAL
gcode:
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("LASER") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.0)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
  {% set SKIP_PROMPT = params.SKIP_PROMPT|default("false")|lower == "true" %}
  
  _GENERATE_NOZZLE_KEY TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}
  {% set nozzle_key = printer.save_variables.variables.nozzle_key %}
  
  M117 Setting up laser job for {nozzle_key}...
  RESPOND TYPE=command MSG="action:notify Setting up laser job for {nozzle_key}"
  RESPOND MSG="Debug: SET_LASER called with TOOLHEAD={TOOLHEAD}, MATERIAL={MATERIAL}, NOZZLE_SIZE={NOZZLE_SIZE}, EXTRUDER={EXTRUDER}, SKIP_PROMPT={SKIP_PROMPT}"

  # Apply laser-specific settings
  SET_MATERIAL TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER} SKIP_PROMPT={SKIP_PROMPT}
  
[gcode_macro SET_DRAG_KNIFE]
description: Configures drag knife job settings and calls SET_MATERIAL
gcode:
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("DRAG_KNIFE") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.0)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
  {% set SKIP_PROMPT = params.SKIP_PROMPT|default("false")|lower == "true" %}
  
  _GENERATE_NOZZLE_KEY TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}
  {% set nozzle_key = printer.save_variables.variables.nozzle_key %}
  
  M117 Setting up drag knife job for {nozzle_key}...
  RESPOND TYPE=command MSG="action:notify Setting up drag knife job for {nozzle_key}"
  RESPOND MSG="Debug: SET_DRAG_KNIFE called with TOOLHEAD={TOOLHEAD}, MATERIAL={MATERIAL}, NOZZLE_SIZE={NOZZLE_SIZE}, EXTRUDER={EXTRUDER}, SKIP_PROMPT={SKIP_PROMPT}"

  # Apply drag knife-specific settings
  SET_MATERIAL TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER} SKIP_PROMPT={SKIP_PROMPT}
[gcode_macro SET_SPINDLE]
description: Configures spindle job settings and calls SET_MATERIAL
gcode:
  {% set TOOLHEAD = params.TOOLHEAD|default("BlockOne") %}
  {% set MATERIAL = params.MATERIAL|default("SPINDLE") %}
  {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.0)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
  {% set SKIP_PROMPT = params.SKIP_PROMPT|default("false")|lower == "true" %}
  
  _GENERATE_NOZZLE_KEY TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER}
  {% set nozzle_key = printer.save_variables.variables.nozzle_key %}
  
  M117 Setting up spindle job for {nozzle_key}...
  RESPOND TYPE=command MSG="action:notify Setting up spindle job for {nozzle_key}"
  RESPOND MSG="Debug: SET_SPINDLE called with TOOLHEAD={TOOLHEAD}, MATERIAL={MATERIAL}, NOZZLE_SIZE={NOZZLE_SIZE}, EXTRUDER={EXTRUDER}, SKIP_PROMPT={SKIP_PROMPT}"

  # Apply spindle-specific settings
  SET_MATERIAL TOOLHEAD={TOOLHEAD} MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} EXTRUDER={EXTRUDER} SKIP_PROMPT={SKIP_PROMPT}

#######################################################################
#  PRINT START / END (called by Mainsail automatically)
#######################################################################
[gcode_macro START_PRINT]
description: Called before a print file begins
gcode:
  M117 Running PreCheck...
  RESPOND TYPE=command MSG="action:notify Running PreCheck"
  PreCheck

  
#######################################################################
#  PRECHECK â€“ runs before job execution
#######################################################################
[gcode_macro PreCheck]
description: Perform homing, preheat, and safety checks
gcode:
  {% set TOOLHEAD = printer.save_variables.variables.set_material_toolhead|default("BlockOne") %}
  {% set MATERIAL = printer.save_variables.variables.set_material_material|default("PLA") %}
  {% set NOZZLE_SIZE = printer.save_variables.variables.set_material_nozzle_size|default(0.4)|float %}
  {% set EXTRUDER = printer.save_variables.variables.set_material_extruder_index|default(0)|int %}
  {% set tool_type = printer["gcode_macro VARIABLES"].toolheads[TOOLHEAD].type %}
  {% set nozzle_key = MATERIAL ~ "_" ~ (NOZZLE_SIZE|string|replace(".", "_")) ~ ("_T" ~ EXTRUDER if TOOLHEAD=="SwitchFly" else "") %}

  M117 Pre-checking for {nozzle_key}...
  RESPOND TYPE=command MSG="action:notify Pre-check for {nozzle_key}"

  # Homing
  {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes %}
    RESPOND TYPE=error MSG="Axes not homed. Run G28."
    { action_raise_error("Axes not homed") }
  {% elif "z" not in printer.toolhead.homed_axes %}
    RESPOND TYPE=error MSG="Z axis not homed. Run G28 Z."
    { action_raise_error("Z axis not homed") }
  {% endif %}

  # Preheat for deposition tools
  {% if tool_type == "DEPOSITION" %}
    PREHEAT
  {% elif tool_type == "LASER" %}
    M5
  {% elif tool_type == "SPINDLE" %}
    M5
  {% elif tool_type == "DRAG_KNIFE" %}
    SET_GCODE_OFFSET Z=0
  {% endif %}

  M117 PreCheck complete
  RESPOND TYPE=command MSG="action:notify PreCheck complete"

[gcode_macro PREHEAT]
description: Heat bed and nozzle before print
gcode:
  {% set bed_temp = printer.save_variables.variables.set_material_bed_temp|default(60)|float %}
  {% set extruder_temp = printer.save_variables.variables.set_material_extruder_temp|default(200)|float %}
  {% set EXTRUDER = printer.save_variables.variables.set_material_extruder_index|default(0)|int %}

  M117 Preheating...
  RESPOND TYPE=command MSG="action:notify Preheating"

  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
  M190 S{bed_temp}
  M104 S{extruder_temp}
  M109 S{extruder_temp}
  M117 Preheat complete
  RESPOND TYPE=command MSG="action:notify Preheat complete"
  LEDFLASH

[gcode_macro Extruder_Check]
description: Check and heat extruder for deposition jobs
gcode:
  {% set EXTRUDER = params.EXTRUDER|default(0)|int %}
  {% set extruder_temp = printer.save_variables.variables.set_material_extruder_temp|float|default(200) %}
  {% set min_extrude_temp = printer["extruder" ~ ("" if EXTRUDER == 0 else EXTRUDER)].min_extrude_temp|default(170)|float %}
  {% set MATERIAL = printer.save_variables.variables.set_material_material|default("PLA") %}
  {% set NOZZLE_SIZE = printer.save_variables.variables.set_material_nozzle_size|float|default(0.4) %}
  {% set TOOLHEAD = printer.save_variables.variables.set_material_toolhead|default("BlockOne") %}
  {% set nozzle_key = MATERIAL ~ (("_" ~ (NOZZLE_SIZE|string|replace(".", "_")) ~ "_T" ~ EXTRUDER) if TOOLHEAD == "SwitchFly" else (("_" ~ (NOZZLE_SIZE|string|replace(".", "_"))) if TOOLHEAD == "BlockOne" else "")) %}

  M117 Checking extruder {EXTRUDER} for {nozzle_key}...
  RESPOND TYPE=command MSG="action:notify Checking extruder {EXTRUDER} for {nozzle_key}"
  RESPOND MSG="Debug: Extruder temp: {printer['extruder' ~ ('' if EXTRUDER == 0 else EXTRUDER)].temperature}, Target: {extruder_temp}, Min: {min_extrude_temp}"

  {% if printer["extruder" ~ ("" if EXTRUDER == 0 else EXTRUDER)].temperature < min_extrude_temp %}
    M117 Heating extruder {EXTRUDER}...
    M104 S{extruder_temp}
    M109 S{extruder_temp}
    M117 Extruder {EXTRUDER} ready for {nozzle_key}
    RESPOND TYPE=command MSG="action:notify Extruder {EXTRUDER} ready for {nozzle_key}"
    LEDFLASH
  {% else %}
    M117 Extruder {EXTRUDER} already hot
    RESPOND TYPE=command MSG="action:notify Extruder {EXTRUDER} already hot for {nozzle_key}"
    M109 S{extruder_temp} ; Ensure temperature
    LEDFLASH
  {% endif %}