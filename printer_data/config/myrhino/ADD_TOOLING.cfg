[gcode_macro ADD_NEW_TOOL]
description: Initiates adding a new toolhead
gcode:
  RESPOND TYPE=command MSG="action:prompt_begin Add New Toolhead"
  RESPOND TYPE=command MSG="action:prompt_input TOOLHEAD_NAME=Enter toolhead name (e.g., NewTool):"
  RESPOND TYPE=command MSG="action:prompt_button Continue|ADD_NEW_TOOL_RESPONSE STEP=1"
  RESPOND TYPE=command MSG="action:prompt_button Cancel|RESET_PRINTER_STATE"
  RESPOND TYPE=command MSG="action:prompt_end"

[gcode_macro EDIT_TOOL]
description: Initiates editing an existing toolhead
gcode:
  {% set toolheads = printer["gcode_macro VARIABLES"].toolheads %}
  {% if toolheads|length == 0 %}
    RESPOND TYPE=error MSG="No toolheads available to edit"
    { action_raise_error("No toolheads defined") }
  {% else %}
    RESPOND TYPE=command MSG="action:prompt_begin Select Toolhead to Edit"
    {% for toolhead in toolheads %}
      RESPOND TYPE=command MSG="action:prompt_button {toolhead}|EDIT_TOOL_RESPONSE STEP=1 TOOLHEAD_NAME='{toolhead}'"
    {% endfor %}
    RESPOND TYPE=command MSG="action:prompt_button Cancel|RESET_PRINTER_STATE"
    RESPOND TYPE=command MSG="action:prompt_end"
  {% endif %}

[gcode_macro DELETE_TOOL]
description: Initiates deleting an existing toolhead
gcode:
  {% set toolheads = printer["gcode_macro VARIABLES"].toolheads %}
  {% if toolheads|length == 0 %}
    RESPOND TYPE=error MSG="No toolheads available to delete"
    { action_raise_error("No toolheads defined") }
  {% else %}
    RESPOND TYPE=command MSG="action:prompt_begin Select Toolhead to Delete"
    {% for toolhead in toolheads %}
      RESPOND TYPE=command MSG="action:prompt_button {toolhead}|DELETE_TOOL_RESPONSE TOOLHEAD_NAME='{toolhead}'"
    {% endfor %}
    RESPOND TYPE=command MSG="action:prompt_button Cancel|RESET_PRINTER_STATE"
    RESPOND TYPE=command MSG="action:prompt_end"
  {% endif %}

[gcode_macro TEST_PROMPT]
description: Test Moonraker prompt
gcode:
  RESPOND TYPE=command MSG="action:prompt_begin Test Prompt"
  RESPOND TYPE=command MSG="action:prompt_input TEST_INPUT=Enter something:"
  RESPOND TYPE=command MSG="action:prompt_button Continue|TEST_RESPONSE"
  RESPOND TYPE=command MSG="action:prompt_button Cancel|RESET_PRINTER_STATE"
  RESPOND TYPE=command MSG="action:prompt_end"

[gcode_macro TEST_RESPONSE]
description: Handle test prompt response
gcode:
  {% set TEST_INPUT = params.TEST_INPUT|default("") %}
  M117 You entered: {TEST_INPUT}
  RESPOND TYPE=command MSG="action:notify You entered: {TEST_INPUT}"
  RESPOND MSG="testing"
  #RESPOND TYPE=command MSG="action:notify Setting parameters for {nozzle_key}"
 # RESPOND MSG="Debug: Tool type: {tool_type}, Nozzle key: {nozzle_key}"


[gcode_macro ADD_TOOLHEAD22]
description: Adds a new toolhead to variables.cfg and toolchanger.cfg with type-based naming
gcode:
    {% set TYPE = params.TYPE|default("")|upper %}
    {% set MATERIAL = params.MATERIAL|default("")|upper %}
    {% set Z_OFFSET = params.Z_OFFSET|default(-1)|float %}
    {% set TEMP_Z_OFFSET = params.TEMP_Z_OFFSET|default(-1)|float %}
    {% set ACCEL = params.ACCEL|default(-1)|float %}
    {% set TEMP_ACCEL = params.TEMP_ACCEL|default(-1)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(-1)|float %}
    {% set TEMP_EXTRUDER_TEMP = params.TEMP_EXTRUDER_TEMP|default(-1)|float %}
    {% set BED_TEMP = params.BED_TEMP|default(-1)|float %}
    {% set TEMP_BED_TEMP = params.TEMP_BED_TEMP|default(-1)|float %}
    {% set FAN_SPEED = params.FAN_SPEED|default(-1)|float %}
    {% set TEMP_FAN_SPEED = params.TEMP_FAN_SPEED|default(-1)|float %}
    {% set LOAD_LENGTH = params.LOAD_LENGTH|default(-1)|float %}
    {% set TEMP_LOAD_LENGTH = params.TEMP_LOAD_LENGTH|default(-1)|float %}
    {% set LOAD_SPEED = params.LOAD_SPEED|default(-1)|float %}
    {% set TEMP_LOAD_SPEED = params.TEMP_LOAD_SPEED|default(-1)|float %}
    {% set LOAD_WAIT = params.LOAD_WAIT|default(-1)|int %}
    {% set TEMP_LOAD_WAIT = params.TEMP_LOAD_WAIT|default(-1)|int %}
    {% set PURGE_LENGTH = params.PURGE_LENGTH|default(-1)|float %}
    {% set TEMP_PURGE_LENGTH = params.TEMP_PURGE_LENGTH|default(-1)|float %}
    {% set PURGE_WAIT = params.PURGE_WAIT|default(-1)|int %}
    {% set TEMP_PURGE_WAIT = params.TEMP_PURGE_WAIT|default(-1)|int %}
    {% set POWER = params.POWER|default(-1)|float %}
    {% set TEMP_POWER = params.TEMP_POWER|default(-1)|float %}
    {% set SPEED = params.SPEED|default(-1)|float %}
    {% set TEMP_SPEED = params.TEMP_SPEED|default(-1)|float %}
    {% set PASSES = params.PASSES|default(-1)|int %}
    {% set TEMP_PASSES = params.TEMP_PASSES|default(-1)|int %}
    {% set EXTRUDER_COUNT = params.EXTRUDER_COUNT|default(-1)|int %}
    {% set TEMP_EXTRUDER_COUNT = params.TEMP_EXTRUDER_COUNT|default(-1)|int %}
    {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(-1)|float %}
    {% set TEMP_NOZZLE_SIZE = params.TEMP_NOZZLE_SIZE|default(-1)|float %}
    {% set TOOL_NUMBER = params.TOOL_NUMBER|default(-1)|int %}
    {% set TEMP_TOOL_NUMBER = params.TEMP_TOOL_NUMBER|default(-1)|int %}
    {% set CONFIRM = params.CONFIRM|default(0)|int %}
    {% set TOOLHEAD = params.TOOLHEAD|default("")|upper %}

    # Debug output
    M117 ADD_TOOLHEAD Started
    RESPOND MSG="ADD_TOOLHEAD macro triggered with TYPE={TYPE}"

    # Check prerequisites
    {% if printer['gcode_macro VARIABLES'] is not defined %}
        { action_raise_error("VARIABLES macro not found. Ensure [gcode_macro VARIABLES] is defined in variables.cfg") }
    {% endif %}
    {% if printer.save_variables is not defined %}
        { action_raise_error("save_variables not found. Ensure [save_variables] is enabled in printer.cfg") }
    {% endif %}
    {% if printer['gcode_macro SET_SERVO_ANGLE'] is not defined %}
        { action_raise_error("SET_SERVO_ANGLE macro not found") }
    {% endif %}

    # Step 1: Toolhead type selection
    {% if TYPE == "" %}
        M117 Select Toolhead Type
        RESPOND TYPE=command MSG="action:prompt_begin Select Toolhead Type"
        RESPOND TYPE=command MSG="action:prompt_text Select toolhead type:"
        RESPOND TYPE=command MSG="action:prompt_button 3D Print|ADD_TOOLHEAD TYPE=3D_PRINT TOOLHEAD=CUSTOM_PRINT_TOOL|primary"
        RESPOND TYPE=command MSG="action:prompt_button Laser|ADD_TOOLHEAD TYPE=LASER TOOLHEAD=CUSTOM_LASER_TOOL MATERIAL=WOOD EXTRUDER_COUNT=0|primary"
        RESPOND TYPE=command MSG="action:prompt_button Drag Knife|ADD_TOOLHEAD TYPE=DRAG_KNIFE TOOLHEAD=CUSTOM_KNIFE_TOOL MATERIAL=VINYL EXTRUDER_COUNT=0|primary"
        RESPOND TYPE=command MSG="action:prompt_button Spindle|ADD_TOOLHEAD TYPE=SPINDLE TOOLHEAD=CUSTOM_SPINDLE_TOOL MATERIAL=WOOD EXTRUDER_COUNT=0|primary"
        RESPOND TYPE=command MSG="action:prompt_footer_button Cancel|action:prompt_end|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    # Step 2: MATERIAL prompt
    {% elif TYPE != "" and MATERIAL == "" %}
        M117 Select MATERIAL for {TYPE}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text Select material:"
        {% if TYPE == "3D_PRINT" %}
            {% set materials = ['ABS', 'ASA', 'PETG', 'PLA'] %}
            {% for mat in materials %}
                RESPOND TYPE=command MSG="action:prompt_button {mat}|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={mat} EXTRUDER_COUNT=1|primary"
            {% endfor %}
        {% elif TYPE == "LASER" %}
            {% set materials = ['WOOD', 'ACRYLIC', 'LEATHER', 'PAPER', 'ALUMINUM'] %}
            {% for mat in materials %}
                RESPOND TYPE=command MSG="action:prompt_button {mat}|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={mat} EXTRUDER_COUNT=0|primary"
            {% endfor %}
        {% elif TYPE == "DRAG_KNIFE" %}
            {% set materials = ['VINYL', 'PAPER', 'FABRIC'] %}
            {% for mat in materials %}
                RESPOND TYPE=command MSG="action:prompt_button {mat}|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={mat} EXTRUDER_COUNT=0|primary"
            {% endfor %}
        {% elif TYPE == "SPINDLE" %}
            {% set materials = ['WOOD', 'ALUMINUM', 'PLASTIC'] %}
            {% for mat in materials %}
                RESPOND TYPE=command MSG="action:prompt_button {mat}|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={mat} EXTRUDER_COUNT=0|primary"
            {% endfor %}
        {% endif %}
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TYPE={TYPE} TOOLHEAD={TOOLHEAD}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    # Step 3: Tool number prompt
    {% elif TYPE != "" and MATERIAL != "" and TOOL_NUMBER == -1 %}
        {% set current_tool_number = TEMP_TOOL_NUMBER if TEMP_TOOL_NUMBER != -1 else 4 %}
        M117 Select TOOL_NUMBER for {TYPE}, Suggested: {current_tool_number}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text TOOL_NUMBER: {current_tool_number} - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TEMP_TOOL_NUMBER={current_tool_number + 1}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TEMP_TOOL_NUMBER={current_tool_number - 1}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={current_tool_number}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    # Step 4: Z_OFFSET prompt
    {% elif TYPE != "" and TOOL_NUMBER != -1 and Z_OFFSET == -1 %}
        {% set current_z = TEMP_Z_OFFSET if TEMP_Z_OFFSET != -1 else (0.1 if TYPE == "3D_PRINT" else 2.0) %}
        M117 Select Z_OFFSET for {TYPE}, Current: {current_z}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text Z_OFFSET: {current_z} mm - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +0.01|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} TEMP_Z_OFFSET={current_z + 0.01}|primary"
        RESPOND TYPE=command MSG="action:prompt_button +0.05|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} TEMP_Z_OFFSET={current_z + 0.05}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -0.01|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} TEMP_Z_OFFSET={current_z - 0.01}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -0.05|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} TEMP_Z_OFFSET={current_z - 0.05}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={current_z}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TEMP_TOOL_NUMBER={TOOL_NUMBER}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    # Step 5: ACCEL prompt
    {% elif TYPE != "" and Z_OFFSET != -1 and ACCEL == -1 %}
        {% set current_accel = TEMP_ACCEL if TEMP_ACCEL != -1 else 2000.0 %}
        M117 Select ACCEL for {TYPE}, Current: {current_accel}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text ACCEL: {current_accel} mm/s² - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +100|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} TEMP_ACCEL={current_accel + 100.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button +500|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} TEMP_ACCEL={current_accel + 500.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -100|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} TEMP_ACCEL={current_accel - 100.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -500|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} TEMP_ACCEL={current_accel - 500.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={current_accel}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} TEMP_Z_OFFSET={Z_OFFSET}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    # Step 6: 3D Print specific prompts
    {% elif TYPE == "3D_PRINT" and ACCEL != -1 and EXTRUDER_TEMP == -1 %}
        {% set current_extruder_temp = TEMP_EXTRUDER_TEMP if TEMP_EXTRUDER_TEMP != -1 else (200.0 if MATERIAL == "PLA" else 230.0 if MATERIAL in ["ABS", "PETG"] else 240.0 if MATERIAL == "ASA" else 200.0) %}
        M117 Select EXTRUDER_TEMP for {TYPE}, Current: {current_extruder_temp}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text EXTRUDER_TEMP: {current_extruder_temp} °C - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +5|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} TEMP_EXTRUDER_TEMP={current_extruder_temp + 5}|primary"
        RESPOND TYPE=command MSG="action:prompt_button +10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} TEMP_EXTRUDER_TEMP={current_extruder_temp + 10}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -5|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} TEMP_EXTRUDER_TEMP={current_extruder_temp - 5}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} TEMP_EXTRUDER_TEMP={current_extruder_temp - 10}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={current_extruder_temp}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} TEMP_ACCEL={ACCEL}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "3D_PRINT" and EXTRUDER_TEMP != -1 and BED_TEMP == -1 %}
        {% set current_bed_temp = TEMP_BED_TEMP if TEMP_BED_TEMP != -1 else (60.0 if MATERIAL == "PLA" else 70.0 if MATERIAL in ["ABS", "PETG"] else 80.0 if MATERIAL == "ASA" else 60.0) %}
        M117 Select BED_TEMP for {TYPE}, Current: {current_bed_temp}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text BED_TEMP: {current_bed_temp} °C - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +5|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} TEMP_BED_TEMP={current_bed_temp + 5}|primary"
        RESPOND TYPE=command MSG="action:prompt_button +10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} TEMP_BED_TEMP={current_bed_temp + 10}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -5|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} TEMP_BED_TEMP={current_bed_temp - 5}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} TEMP_BED_TEMP={current_bed_temp - 10}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={current_bed_temp}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} TEMP_EXTRUDER_TEMP={EXTRUDER_TEMP}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "3D_PRINT" and BED_TEMP != -1 and FAN_SPEED == -1 %}
        {% set current_fan_speed = TEMP_FAN_SPEED if TEMP_FAN_SPEED != -1 else (0.5 if MATERIAL == "PLA" else 0.3 if MATERIAL in ["ABS", "ASA"] else 0.4 if MATERIAL == "PETG" else 0.5) %}
        M117 Select FAN_SPEED for {TYPE}, Current: {current_fan_speed}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text FAN_SPEED: {current_fan_speed} (0.0-1.0) - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +0.1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} TEMP_FAN_SPEED={current_fan_speed + 0.1}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -0.1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} TEMP_FAN_SPEED={current_fan_speed - 0.1}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={current_fan_speed}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} TEMP_BED_TEMP={BED_TEMP}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "3D_PRINT" and FAN_SPEED != -1 and NOZZLE_SIZE == -1 %}
        {% set current_nozzle_size = TEMP_NOZZLE_SIZE if TEMP_NOZZLE_SIZE != -1 else 0.4 %}
        M117 Select NOZZLE_SIZE for {TYPE}, Current: {current_nozzle_size}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text NOZZLE_SIZE: {current_nozzle_size} mm - Select:"
        RESPOND TYPE=command MSG="action:prompt_button 0.4|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE=0.4|primary"
        RESPOND TYPE=command MSG="action:prompt_button 0.8|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE=0.8|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={current_nozzle_size}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} TEMP_FAN_SPEED={FAN_SPEED}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "3D_PRINT" and NOZZLE_SIZE != -1 and LOAD_LENGTH == -1 %}
        {% set current_load_length = TEMP_LOAD_LENGTH if TEMP_LOAD_LENGTH != -1 else 10.0 %}
        M117 Select LOAD_LENGTH for {TYPE}, Current: {current_load_length}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text LOAD_LENGTH: {current_load_length} mm - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} TEMP_LOAD_LENGTH={current_load_length + 1.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} TEMP_LOAD_LENGTH={current_load_length - 1.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={current_load_length}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} TEMP_NOZZLE_SIZE={NOZZLE_SIZE}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "3D_PRINT" and LOAD_LENGTH != -1 and LOAD_SPEED == -1 %}
        {% set current_load_speed = TEMP_LOAD_SPEED if TEMP_LOAD_SPEED != -1 else 50.0 %}
        M117 Select LOAD_SPEED for {TYPE}, Current: {current_load_speed}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text LOAD_SPEED: {current_load_speed} mm/s - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} TEMP_LOAD_SPEED={current_load_speed + 10.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} TEMP_LOAD_SPEED={current_load_speed - 10.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={current_load_speed}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} TEMP_LOAD_LENGTH={LOAD_LENGTH}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "3D_PRINT" and LOAD_SPEED != -1 and LOAD_WAIT == -1 %}
        {% set current_load_wait = TEMP_LOAD_WAIT if TEMP_LOAD_WAIT != -1 else 1000 %}
        M117 Select LOAD_WAIT for {TYPE}, Current: {current_load_wait}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text LOAD_WAIT: {current_load_wait} ms - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +100|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} TEMP_LOAD_WAIT={current_load_wait + 100}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -100|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} TEMP_LOAD_WAIT={current_load_wait - 100}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={current_load_wait}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} TEMP_LOAD_SPEED={LOAD_SPEED}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "3D_PRINT" and LOAD_WAIT != -1 and PURGE_LENGTH == -1 %}
        {% set current_purge_length = TEMP_PURGE_LENGTH if TEMP_PURGE_LENGTH != -1 else 12.0 %}
        M117 Select PURGE_LENGTH for {TYPE}, Current: {current_purge_length}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text PURGE_LENGTH: {current_purge_length} mm - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} TEMP_PURGE_LENGTH={current_purge_length + 1.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} TEMP_PURGE_LENGTH={current_purge_length - 1.0}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} PURGE_LENGTH={current_purge_length}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} TEMP_LOAD_WAIT={LOAD_WAIT}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "3D_PRINT" and PURGE_LENGTH != -1 and PURGE_WAIT == -1 %}
        {% set current_purge_wait = TEMP_PURGE_WAIT if TEMP_PURGE_WAIT != -1 else 2000 %}
        M117 Select PURGE_WAIT for {TYPE}, Current: {current_purge_wait}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text PURGE_WAIT: {current_purge_wait} ms - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +100|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} PURGE_LENGTH={PURGE_LENGTH} TEMP_PURGE_WAIT={current_purge_wait + 100}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -100|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} PURGE_LENGTH={PURGE_LENGTH} TEMP_PURGE_WAIT={current_purge_wait - 100}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} PURGE_LENGTH={PURGE_LENGTH} PURGE_WAIT={current_purge_wait}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} TEMP_PURGE_LENGTH={PURGE_LENGTH}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "3D_PRINT" and PURGE_WAIT != -1 and EXTRUDER_COUNT == -1 %}
        {% set current_extruder_count = TEMP_EXTRUDER_COUNT if TEMP_EXTRUDER_COUNT != -1 else 1 %}
        M117 Select EXTRUDER_COUNT for {TYPE}, Current: {current_extruder_count}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text EXTRUDER_COUNT: {current_extruder_count} - Select:"
        RESPOND TYPE=command MSG="action:prompt_button 1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} PURGE_LENGTH={PURGE_LENGTH} PURGE_WAIT={PURGE_WAIT} EXTRUDER_COUNT=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button 2|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} PURGE_LENGTH={PURGE_LENGTH} PURGE_WAIT={PURGE_WAIT} EXTRUDER_COUNT=2|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} PURGE_LENGTH={PURGE_LENGTH} PURGE_WAIT={PURGE_WAIT} EXTRUDER_COUNT={current_extruder_count}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} EXTRUDER_TEMP={EXTRUDER_TEMP} BED_TEMP={BED_TEMP} FAN_SPEED={FAN_SPEED} NOZZLE_SIZE={NOZZLE_SIZE} LOAD_LENGTH={LOAD_LENGTH} LOAD_SPEED={LOAD_SPEED} LOAD_WAIT={LOAD_WAIT} PURGE_LENGTH={PURGE_LENGTH} TEMP_PURGE_WAIT={PURGE_WAIT}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    # Laser specific prompts
    {% elif TYPE == "LASER" and ACCEL != -1 and POWER == -1 %}
        {% set current_power = TEMP_POWER if TEMP_POWER != -1 else (40.0 if MATERIAL == "WOOD" else 90.0 if MATERIAL == "ACRYLIC" else 30.0 if MATERIAL == "LEATHER" else 20.0 if MATERIAL == "PAPER" else 60.0) %}
        M117 Select POWER for {TYPE}, Current: {current_power}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text POWER: {current_power}% - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} TEMP_POWER={current_power + 10}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} TEMP_POWER={current_power - 10}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={current_power}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} TEMP_ACCEL={ACCEL}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "LASER" and POWER != -1 and SPEED == -1 %}
        {% set current_speed = TEMP_SPEED if TEMP_SPEED != -1 else (300.0 if MATERIAL == "WOOD" else 100.0 if MATERIAL == "ACRYLIC" else 400.0 if MATERIAL == "LEATHER" else 500.0 if MATERIAL == "PAPER" else 200.0) %}
        M117 Select SPEED for {TYPE}, Current: {current_speed}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text SPEED: {current_speed} mm/s - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} TEMP_SPEED={current_speed + 10}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -10|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} TEMP_SPEED={current_speed - 10}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} SPEED={current_speed}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} TEMP_POWER={POWER}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "LASER" and SPEED != -1 and PASSES == -1 %}
        {% set current_passes = TEMP_PASSES if TEMP_PASSES != -1 else (1 if MATERIAL in ["WOOD", "LEATHER", "PAPER", "ALUMINUM"] else 2) %}
        M117 Select PASSES for {TYPE}, Current: {current_passes}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text PASSES: {current_passes} - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} SPEED={SPEED} TEMP_PASSES={current_passes + 1}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} SPEED={SPEED} TEMP_PASSES={current_passes - 1}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} SPEED={SPEED} PASSES={current_passes}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} TEMP_SPEED={SPEED}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% elif TYPE == "LASER" and PASSES != -1 and FAN_SPEED == -1 %}
        {% set current_fan_speed = TEMP_FAN_SPEED if TEMP_FAN_SPEED != -1 else 0.0 %}
        M117 Select FAN_SPEED for {TYPE}, Current: {current_fan_speed}
        RESPOND TYPE=command MSG="action:prompt_begin Configure {TYPE} Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text FAN_SPEED: {current_fan_speed} (0.0-1.0) - Adjust:"
        RESPOND TYPE=command MSG="action:prompt_button +0.1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} SPEED={SPEED} PASSES={PASSES} TEMP_FAN_SPEED={current_fan_speed + 0.1}|primary"
        RESPOND TYPE=command MSG="action:prompt_button -0.1|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} SPEED={SPEED} PASSES={PASSES} TEMP_FAN_SPEED={current_fan_speed - 0.1}|primary"
        RESPOND TYPE=command MSG="action:prompt_button Use Default|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} SPEED={SPEED} PASSES={PASSES} FAN_SPEED={current_fan_speed}|success"
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL} POWER={POWER} SPEED={SPEED} TEMP_PASSES={PASSES}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    # Confirmation prompt
    {% elif TYPE != "" and MATERIAL != "" and TOOL_NUMBER != -1 and Z_OFFSET != -1 and ACCEL != -1 and ((TYPE == "3D_PRINT" and EXTRUDER_TEMP != -1 and BED_TEMP != -1 and FAN_SPEED != -1 and NOZZLE_SIZE != -1 and LOAD_LENGTH != -1 and LOAD_SPEED != -1 and LOAD_WAIT != -1 and PURGE_LENGTH != -1 and PURGE_WAIT != -1 and EXTRUDER_COUNT != -1) or (TYPE == "LASER" and POWER != -1 and SPEED != -1 and PASSES != -1 and FAN_SPEED != -1) or TYPE in ["DRAG_KNIFE", "SPINDLE"]) and CONFIRM == 0 %}
        M117 Confirm Settings for {TYPE}
        RESPOND TYPE=command MSG="action:prompt_begin Confirm {TYPE} Toolhead Settings: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text Tool Number: {TOOL_NUMBER}"
        RESPOND TYPE=command MSG="action:prompt_text Type: {TYPE}"
        RESPOND TYPE=command MSG="action:prompt_text Material: {MATERIAL}"
        RESPOND TYPE=command MSG="action:prompt_text Z_OFFSET: {Z_OFFSET} mm"
        RESPOND TYPE=command MSG="action:prompt_text ACCEL: {ACCEL} mm/s²"
        {% if TYPE == "3D_PRINT" %}
            RESPOND TYPE=command MSG="action:prompt_text EXTRUDER_TEMP: {EXTRUDER_TEMP} °C"
            RESPOND TYPE=command MSG="action:prompt_text BED_TEMP: {BED_TEMP} °C"
            RESPOND TYPE=command MSG="action:prompt_text FAN_SPEED: {FAN_SPEED}"
            RESPOND TYPE=command MSG="action:prompt_text NOZZLE_SIZE: {NOZZLE_SIZE} mm"
            RESPOND TYPE=command MSG="action:prompt_text LOAD_LENGTH: {LOAD_LENGTH} mm"
            RESPOND TYPE=command MSG="action:prompt_text LOAD_SPEED: {LOAD_SPEED} mm/s"
            RESPOND TYPE=command MSG="action:prompt_text LOAD_WAIT: {LOAD_WAIT} ms"
            RESPOND TYPE=command MSG="action:prompt_text PURGE_LENGTH: {PURGE_LENGTH} mm"
            RESPOND TYPE=command MSG="action:prompt_text PURGE_WAIT: {PURGE_WAIT} ms"
            RESPOND TYPE=command MSG="action:prompt_text EXTRUDER_COUNT: {EXTRUDER_COUNT}"
        {% elif TYPE == "LASER" %}
            RESPOND TYPE=command MSG="action:prompt_text POWER: {POWER} %"
            RESPOND TYPE=command MSG="action:prompt_text SPEED: {SPEED} mm/s"
            RESPOND TYPE=command MSG="action:prompt_text PASSES: {PASSES}"
            RESPOND TYPE=command MSG="action:prompt_text FAN_SPEED: {FAN_SPEED}"
        {% endif %}
        {% set save_params = "TOOLHEAD=\"" ~ TOOLHEAD ~ "\" TYPE=" ~ TYPE ~ " MATERIAL=\"" ~ MATERIAL ~ "\"" ~ " EXTRUDER_COUNT=" ~ EXTRUDER_COUNT ~ " TOOL_NUMBER=" ~ TOOL_NUMBER ~ " Z_OFFSET=" ~ Z_OFFSET ~ " ACCEL=" ~ ACCEL %}
        {% if TYPE == "3D_PRINT" %}
            {% set save_params = save_params ~ " EXTRUDER_TEMP=" ~ EXTRUDER_TEMP ~ " BED_TEMP=" ~ BED_TEMP ~ " FAN_SPEED=" ~ FAN_SPEED ~ " NOZZLE_SIZE=" ~ NOZZLE_SIZE ~ " LOAD_LENGTH=" ~ LOAD_LENGTH ~ " LOAD_SPEED=" ~ LOAD_SPEED ~ " LOAD_WAIT=" ~ LOAD_WAIT ~ " PURGE_LENGTH=" ~ PURGE_LENGTH ~ " PURGE_WAIT=" ~ PURGE_WAIT %}
        {% elif TYPE == "LASER" %}
            {% set save_params = save_params ~ " POWER=" ~ POWER ~ " SPEED=" ~ SPEED ~ " PASSES=" ~ PASSES ~ " FAN_SPEED=" ~ FAN_SPEED %}
        {% endif %}
        RESPOND TYPE=command MSG="action:prompt_button Save|ADD_TOOLHEAD {save_params} CONFIRM=1|success"
        {% set back_params = "TOOLHEAD={TOOLHEAD} TYPE={TYPE} MATERIAL={MATERIAL} EXTRUDER_COUNT={EXTRUDER_COUNT} TOOL_NUMBER={TOOL_NUMBER} Z_OFFSET={Z_OFFSET} ACCEL={ACCEL}" %}
        {% if TYPE == "3D_PRINT" %}
            {% set back_params = back_params ~ " TEMP_EXTRUDER_TEMP={EXTRUDER_TEMP} TEMP_BED_TEMP={BED_TEMP} TEMP_FAN_SPEED={FAN_SPEED} TEMP_NOZZLE_SIZE={NOZZLE_SIZE} TEMP_LOAD_LENGTH={LOAD_LENGTH} TEMP_LOAD_SPEED={LOAD_SPEED} TEMP_LOAD_WAIT={LOAD_WAIT} TEMP_PURGE_LENGTH={PURGE_LENGTH} TEMP_PURGE_WAIT={PURGE_WAIT}" %}
        {% elif TYPE == "LASER" %}
            {% set back_params = back_params ~ " TEMP_POWER={POWER} TEMP_SPEED={SPEED} TEMP_PASSES={PASSES} TEMP_FAN_SPEED={FAN_SPEED}" %}
        {% endif %}
        RESPOND TYPE=command MSG="action:prompt_footer_button Back|ADD_TOOLHEAD {back_params}|secondary"
        RESPOND TYPE=command MSG="action:prompt_show"
    # Save to variables.cfg and toolchanger.cfg
    {% else %}
        # Validate inputs
        {% set toolheads = printer['gcode_macro VARIABLES'].toolheads %}
        {% if TOOLHEAD|lower in toolheads %}
            { action_raise_error("Toolhead {TOOLHEAD} already exists in variables.cfg") }
        {% endif %}
        {% if TYPE not in ['3D_PRINT', 'LASER', 'DRAG_KNIFE', 'SPINDLE'] %}
            { action_raise_error("Invalid TYPE: " ~ TYPE) }
        {% endif %}
        {% if Z_OFFSET < -10 or Z_OFFSET > 10 %}
            { action_raise_error("Z_OFFSET must be between -10 and 10 mm") }
        {% endif %}
        {% if ACCEL < 500 or ACCEL > 3000 %}
            { action_raise_error("ACCEL must be between 500 and 3000 mm/s²") }
        {% endif %}
        {% if TYPE == "3D_PRINT" %}
            {% if EXTRUDER_TEMP < 150 or EXTRUDER_TEMP > 300 %}
                { action_raise_error("EXTRUDER_TEMP must be between 150 and 300 °C") }
            {% endif %}
            {% if BED_TEMP < 0 or BED_TEMP > 100 %}
                { action_raise_error("BED_TEMP must be between 0 and 100 °C") }
            {% endif %}
            {% if FAN_SPEED < 0.0 or FAN_SPEED > 1.0 %}
                { action_raise_error("FAN_SPEED must be between 0.0 and 1.0") }
            {% endif %}
            {% if NOZZLE_SIZE not in [0.4, 0.8] %}
                { action_raise_error("NOZZLE_SIZE must be 0.4 or 0.8 mm") }
            {% endif %}
            {% if LOAD_LENGTH < 0 or LOAD_LENGTH > 50 %}
                { action_raise_error("LOAD_LENGTH must be between 0 and 50 mm") }
            {% endif %}
            {% if LOAD_SPEED < 10 or LOAD_SPEED > 100 %}
                { action_raise_error("LOAD_SPEED must be between 10 and 100 mm/s") }
            {% endif %}
            {% if LOAD_WAIT < 0 or LOAD_WAIT > 5000 %}
                { action_raise_error("LOAD_WAIT must be between 0 and 5000 ms") }
            {% endif %}
            {% if PURGE_LENGTH < 0 or PURGE_LENGTH > 50 %}
                { action_raise_error("PURGE_LENGTH must be between 0 and 50 mm") }
            {% endif %}
            {% if PURGE_WAIT < 0 or PURGE_WAIT > 5000 %}
                { action_raise_error("PURGE_WAIT must be between 0 and 5000 ms") }
            {% endif %}
            {% if EXTRUDER_COUNT < 1 or EXTRUDER_COUNT > 2 %}
                { action_raise_error("EXTRUDER_COUNT must be 1 or 2") }
            {% endif %}
            {% set valid_materials = ['ABS', 'ASA', 'PETG', 'PLA'] %}
            {% if MATERIAL not in valid_materials %}
                { action_raise_error("Invalid MATERIAL: {MATERIAL}. Must be one of: " ~ valid_materials|join(', ')) }
            {% endif %}
        {% elif TYPE == "LASER" %}
            {% if POWER < 0 or POWER > 100 %}
                { action_raise_error("POWER must be between 0 and 100 %") }
            {% endif %}
            {% if SPEED < 5 or SPEED > 1000 %}
                { action_raise_error("SPEED must be between 5 and 1000 mm/s") }
            {% endif %}
            {% if PASSES < 1 or PASSES > 10 %}
                { action_raise_error("PASSES must be between 1 and 10") }
            {% endif %}
            {% if FAN_SPEED < 0.0 or FAN_SPEED > 1.0 %}
                { action_raise_error("FAN_SPEED must be between 0.0 and 1.0") }
            {% endif %}
            {% set valid_materials = ['WOOD', 'ACRYLIC', 'LEATHER', 'PAPER', 'ALUMINUM'] %}
            {% if MATERIAL not in valid_materials %}
                { action_raise_error("Invalid MATERIAL: {MATERIAL}. Must be one of: " ~ valid_materials|join(', ')) }
            {% endif %}
        {% endif %}

        # Save to variables.cfg
        {% set toolhead_lower = TOOLHEAD|lower %}
        {% set tool_params = {"type": TYPE, "materials": {}} %}
        {% if TYPE == "3D_PRINT" %}
            {% set material_key = MATERIAL ~ "_" ~ NOZZLE_SIZE %}
            {% set materials_dict = {
                material_key: {
                    "z_offset": Z_OFFSET,
                    "accel": ACCEL,
                    "extruder_temp": EXTRUDER_TEMP,
                    "bed_temp": BED_TEMP,
                    "fan_speed": FAN_SPEED,
                    "nozzle_size": NOZZLE_SIZE,
                    "load_length": LOAD_LENGTH,
                    "load_speed": LOAD_SPEED,
                    "load_wait": LOAD_WAIT,
                    "purge_length": PURGE_LENGTH,
                    "purge_wait": PURGE_WAIT,
                    "extruder_count": EXTRUDER_COUNT
                }
            } %}
            {% set tool_params = {"type": TYPE, "materials": materials_dict} %}
        {% elif TYPE == "LASER" %}
            {% set materials_dict = {
                MATERIAL: {
                    "z_offset": Z_OFFSET,
                    "accel": ACCEL,
                    "power": POWER,
                    "speed": SPEED,
                    "passes": PASSES,
                    "fan_speed": FAN_SPEED
                }
            } %}
            {% set tool_params = {"type": TYPE, "materials": materials_dict} %}
        {% elif TYPE in ["DRAG_KNIFE", "SPINDLE"] %}
            {% set materials_dict = {
                MATERIAL: {
                    "z_offset": Z_OFFSET,
                    "accel": ACCEL,
                    "fan_speed": FAN_SPEED
                }
            } %}
            {% set tool_params = {"type": TYPE, "materials": materials_dict} %}
        {% endif %}
        M117 Saving toolhead: {toolhead_lower} to variables.cfg
        SAVE_VARIABLE VARIABLE=toolheads.{toolhead_lower} VALUE="{tool_params}"
        SAVE_CONFIG

        # Generate toolchanger.cfg entries
        {% if TYPE == "3D_PRINT" %}
            {% if EXTRUDER_COUNT == 1 %}
                {% set tool_content = "[tool T" ~ TOOL_NUMBER ~ "]\n" ~
                                      "tool_number: " ~ TOOL_NUMBER ~ "\n" ~
                                      "extruder: extruder\n" ~
                                      "pickup_gcode:\n" ~
                                      "  G28\n" ~
                                      "  G1 X550 Y400 Z5 F6000\n" ~
                                      "dropoff_gcode:\n" ~
                                      "  G1 X550 Y400 Z50 F6000\n" ~
                                      "gcode_x_offset: 0\n" ~
                                      "gcode_y_offset: 0\n" ~
                                      "gcode_z_offset: " ~ Z_OFFSET ~ "\n" ~
                                      "params_park_x: 0.0\n" ~
                                      "params_park_y: -7.4\n" ~
                                      "params_park_z: 349.5\n" %}
                RUN_SHELL_COMMAND CMD=add_tool_to_toolchanger PARAMS="{tool_content}"
            {% else %}
                {% set tool_content1 = "[tool T" ~ TOOL_NUMBER ~ "]\n" ~
                                       "tool_number: " ~ TOOL_NUMBER ~ "\n" ~
                                       "extruder: extruder\n" ~
                                       "pickup_gcode:\n" ~
                                       "  G28\n" ~
                                       "  G1 X550 Y400 Z5 F6000\n" ~
                                       "  SET_SERVO_ANGLE ANGLE=0\n" ~
                                       "  G4 P1000\n" ~
                                       "dropoff_gcode:\n" ~
                                       "  G1 X550 Y400 Z50 F6000\n" ~
                                       "gcode_x_offset: 0\n" ~
                                       "gcode_y_offset: 0\n" ~
                                       "gcode_z_offset: " ~ Z_OFFSET ~ "\n" ~
                                       "params_park_x: 0.0\n" ~
                                       "params_park_y: -7.4\n" ~
                                       "params_park_z: 349.5\n" %}
                {% set tool_content2 = "[tool T" ~ (TOOL_NUMBER + 1) ~ "]\n" ~
                                       "tool_number: " ~ (TOOL_NUMBER + 1) ~ "\n" ~
                                       "extruder: extruder\n" ~
                                       "pickup_gcode:\n" ~
                                       "  G28\n" ~
                                       "  G1 X550 Y400 Z5 F6000\n" ~
                                       "  SET_SERVO_ANGLE ANGLE=180\n" ~
                                       "  G4 P1000\n" ~
                                       "dropoff_gcode:\n" ~
                                       "  G1 X550 Y400 Z50 F6000\n" ~
                                       "gcode_x_offset: 0\n" ~
                                       "gcode_y_offset: 0\n" ~
                                       "gcode_z_offset: " ~ Z_OFFSET ~ "\n" ~
                                       "params_park_x: 0.0\n" ~
                                       "params_park_y: -7.4\n" ~
                                       "params_park_z: 349.5\n" %}
                RUN_SHELL_COMMAND CMD=add_tool_to_toolchanger PARAMS="{tool_content1}"
                RUN_SHELL_COMMAND CMD=add_tool_to_toolchanger PARAMS="{tool_content2}"
            {% endif %}
        {% elif TYPE == "LASER" %}
            {% set tool_content = "[tool T" ~ TOOL_NUMBER ~ "]\n" ~
                                  "tool_number: " ~ TOOL_NUMBER ~ "\n" ~
                                  "extruder: none\n" ~
                                  "pickup_gcode:\n" ~
                                  "  G28\n" ~
                                  "  G1 X550 Y400 Z5 F6000\n" ~
                                  "  SET_SERVO_ANGLE ANGLE=0\n" ~
                                  "  G4 P1000\n" ~
                                  "dropoff_gcode:\n" ~
                                  "  G1 X550 Y400 Z50 F6000\n" ~
                                  "  SET_SERVO_ANGLE ANGLE=180\n" ~
                                  "  G4 P1000\n" ~
                                  "gcode_x_offset: 0\n" ~
                                  "gcode_y_offset: 0\n" ~
                                  "gcode_z_offset: " ~ Z_OFFSET ~ "\n" ~
                                  "params_park_x: 0.0\n" ~
                                  "params_park_y: -7.4\n" ~
                                  "params_park_z: 350.0\n" %}
            RUN_SHELL_COMMAND CMD=add_tool_to_toolchanger PARAMS="{tool_content}"
        {% elif TYPE == "DRAG_KNIFE" %}
            {% set valid_materials = ['VINYL', 'PAPER', 'FABRIC'] %}
            {% if MATERIAL not in valid_materials %}
                { action_raise_error("Invalid MATERIAL: {MATERIAL}. Must be one of: " ~ valid_materials|join(', ')) }
            {% endif %}
            {% set tool_content = "[tool T" ~ TOOL_NUMBER ~ "]\n" ~
                                  "tool_number: " ~ TOOL_NUMBER ~ "\n" ~
                                  "extruder: none\n" ~
                                  "pickup_gcode:\n" ~
                                  "  G28\n" ~
                                  "  G1 X550 Y400 Z5 F6000\n" ~
                                  "dropoff_gcode:\n" ~
                                  "  G1 X550 Y400 Z50 F6000\n" ~
                                  "gcode_x_offset: 0\n" ~
                                  "gcode_y_offset: 0\n" ~
                                  "gcode_z_offset: " ~ Z_OFFSET ~ "\n" ~
                                  "params_park_x: 0.0\n" ~
                                  "params_park_y: -7.4\n" ~
                                  "params_park_z: 349.5\n" %}
            RUN_SHELL_COMMAND CMD=add_tool_to_toolchanger PARAMS="{tool_content}"
        {% elif TYPE == "SPINDLE" %}
            {% set valid_materials = ['WOOD', 'ALUMINUM', 'PLASTIC'] %}
            {% if MATERIAL not in valid_materials %}
                { action_raise_error("Invalid MATERIAL: {MATERIAL}. Must be one of: " ~ valid_materials|join(', ')) }
            {% endif %}
            {% set tool_content = "[tool T" ~ TOOL_NUMBER ~ "]\n" ~
                                  "tool_number: " ~ TOOL_NUMBER ~ "\n" ~
                                  "extruder: none\n" ~
                                  "pickup_gcode:\n" ~
                                  "  G28\n" ~
                                  "  G1 X550 Y400 Z5 F6000\n" ~
                                  "dropoff_gcode:\n" ~
                                  "  G1 X550 Y400 Z50 F6000\n" ~
                                  "gcode_x_offset: 0\n" ~
                                  "gcode_y_offset: 0\n" ~
                                  "gcode_z_offset: " ~ Z_OFFSET ~ "\n" ~
                                  "params_park_x: 0.0\n" ~
                                  "params_park_y: -7.4\n" ~
                                  "params_park_z: 349.5\n" %}
            RUN_SHELL_COMMAND CMD=add_tool_to_toolchanger PARAMS="{tool_content}"
        {% endif %}

        # Signal completion
        M117 Toolhead {TOOLHEAD} added successfully
        RESPOND MSG="Toolhead {TOOLHEAD} (Type: {TYPE}, Tool Number: {TOOL_NUMBER}) added to variables.cfg and toolchanger.cfg"
        RESPOND TYPE=command MSG="action:prompt_begin Toolhead Added Successfully"
        RESPOND TYPE=command MSG="action:prompt_text Toolhead: {TOOLHEAD}"
        RESPOND TYPE=command MSG="action:prompt_text Type: {TYPE}"
        RESPOND TYPE=command MSG="action:prompt_text Tool Number: {TOOL_NUMBER}"
        RESPOND TYPE=command MSG="action:prompt_footer_button Done|action:prompt_end|success"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% endif %}